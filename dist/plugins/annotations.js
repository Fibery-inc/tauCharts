/*!
 * /*
 * taucharts@2.7.0 (2019-03-08)
 * Copyright 2019 Targetprocess, Inc.
 * Licensed under Apache License 2.0
 * * /
 * 
 */
!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e(require("taucharts"),require("d3-color"));else if("function"==typeof define&&define.amd)define(["taucharts","d3-color"],e);else{var a="object"==typeof exports?e(require("taucharts"),require("d3-color")):e(t.Taucharts,t.d3);for(var r in a)("object"==typeof exports?exports:t)[r]=a[r]}}(window,function(t,e){return function(t){var e={};function a(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,a),n.l=!0,n.exports}return a.m=t,a.c=e,a.d=function(t,e,r){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)a.d(r,n,function(e){return t[e]}.bind(null,n));return r},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="",a(a.s=14)}({0:function(e,a){e.exports=t},14:function(t,e,a){"use strict";a.r(e);var r=a(0),n=a.n(r),i=a(5);function o(t,e){return t.replace(/\{\{\s*(.+?)\s*\}\}/g,(t,a)=>e.hasOwnProperty(a)?e[a]:"")}var s=n.a.api.utils,l=n.a.api.pluginsSDK,c=function(t,e,a){"front"===a?t.push(e):t.unshift(e)},d=function(t){return function(e){var a={},r=[{dim:e.scaleX.dim,scale:e.scaleY,method:"yi"},{dim:e.scaleY.dim,scale:e.scaleX,method:"xi"},{dim:null,scale:null,method:null,k:null}].find(function(e){return Array.isArray(t.dim)?t.dim.indexOf(e.dim)>=0:e.dim===t.dim});if(null===r.method)return a;var i={l:-.5,r:.5},o=r.method,s=r.scale;return a[o]=function(t){var a=i[t.__pos__]||0;if(s.discrete)return e[o](t)+s.stepSize(t[s.dim])*a;if(s.period){const e=n.a.api.tickPeriod.get(s.period,{utc:s.utcTime}),a=s.domain();let r=e.cast(a[0]);for(;r<a[0];)r=e.next(r);const i=e.cast(a[1]),o=(s(i)-s(r))/(i-r);switch(t.__pos__){case"l":{const t=Math.min(0,a[0]-r);return s(r)+o*t}case"r":{const t=Math.max(0,a[1]-i);return s(i)+o*t}}}return e[o](t)},a}};function u(t){const e=s.defaults(t||{},{items:[],formatters:{}});return{init(t){this._chart=t;var e=t.getSpec();e.scales.annotation_text={type:"value",dim:"text",source:"?"},e.transformations=e.transformations||{};const a=t=>e.settings.log(t,"LOG");this._dataRefs={},e.transformations.dataRange=((r,i)=>{var s=i.from,l=i.to,c=t.getScaleInfo(i.primaryScale),d=c.domain();if(c.period){var u=n.a.api.tickPeriod.get(c.period,{utc:e.settings.utcTime});s=u.cast(new Date(i.from)),l=u.cast(new Date(i.to))}s=null===s?d[0]:s,l=null===l?d[d.length-1]:l;var f=!c.isInDomain(s),m=!c.isInDomain(l);if(c.discrete?f||m:f&&m)return a("Annotation is out of domain"),[];var p=t.getScaleInfo(i.secondaryScale),y=p.domain(),h=[y[0],y[y.length-1]],g=c.dim,x=p.dim,_="__pos__",v={},S={},b={},A={};v[_]="l",v[g]=s,v[x]=h[0],S[_]="l",S[g]=l,S[x]=h[0],b[_]="r",b[g]=l,b[x]=h[1],A[_]="r",A[g]=s,A[x]=h[1];const D="y"===i.axis?b:A,T="y"===i.axis?A:b,R=this._getFormat(g);return i.startText&&(D.text=o(i.startText,{value:R(D[g])})),i.endText&&(T.text=o(i.endText,{value:R(T[g])})),this._useSavedDataRefs([v,S,b,A],String([g,s,l]))}),e.transformations.dataLimit=((r,i)=>{var s=i.primaryScale,l=i.secondaryScale,c=t.getScaleInfo(s),d=c.period?n.a.api.tickPeriod.get(c.period,{utc:e.settings.utcTime}).cast(new Date(i.from)):i.from;if(!c.isInDomain(d))return a("Annotation is out of domain"),[];var u=t.getScaleInfo(l),f=u.domain(),m=[f[0],f[f.length-1]],p={},y={},h=c.dim,g=u.dim,x="__pos__";const _=this._getFormat(h);return p[h]=d,p[g]=m[0],p[x]="l",i.startText&&(p.text=o(i.startText,{value:_(d)})),y[h]=d,y[g]=m[1],y[x]="r",i.endText&&(y.text=o(i.endText,{value:_(d)})),this._useSavedDataRefs([p,y],String([h,g,d]))}),e.transformations.lineNoteData=((e,r)=>{const i=r.xScale,s=r.yScale,l=t.getScaleInfo(i),c=t.getScaleInfo(s),d=l.period?n.a.api.tickPeriod.get(l.period,{utc:l.utcTime}):null,u=c.period?n.a.api.tickPeriod.get(c.period,{utc:c.utcTime}):null,f=r.points.map(t=>[d?d.cast(t[0]):t[0],u?u.cast(t[1]):t[1]]);if(f.some(t=>!l.isInDomain(t[0])||!c.isInDomain(t[1])))return a("Annotation is out of domain"),[];const m=l.dim,p=c.dim,y=[m,p].map(t=>this._getFormat(t)),h=f.map((t,e)=>{0===e||f.length;const a=0===e?r.startText:e===f.length-1?r.endText:"";return{[m]:t[0],[p]:t[1],text:a?o(a,{x:y[0](t[0]),y:y[1](t[1])}):null}});return this._useSavedDataRefs(h,JSON.stringify([m,p,r.points]))})},addAreaNote:function(t,e,a){var r=t.scales[e.x],n=t.scales[e.y],i=a.dim===r.dim?["x","y"]:a.dim===n.dim?["y","x"]:null;if(null===i)return void(e=>t.settings.log(e,"LOG"))("Annotation doesn't match any data field");var o=a.val[0],s=a.val[1];const l=a.text;var u={type:"ELEMENT.PATH",namespace:"annotations",x:e.x,y:e.y,color:a.colorScaleName,label:"annotation_text",expression:{inherit:!1,operator:"none",params:[],source:"/"},transformModel:[d(a)],transformation:[{type:"dataRange",args:{axis:i[0],startText:"string"==typeof l?l:l.start,endText:"string"==typeof l?"":l.end,from:o,to:s,primaryScale:e[i[0]],secondaryScale:e[i[1]]}}],guide:{animationSpeed:e.guide.animationSpeed,showAnchors:"never",cssClass:"tau-chart__annotation-area",label:{fontColor:a.color,position:["r","b","keep-in-box"]}}};c(e.units,u,a.position)},addLineNote:function(t,e,a){var r=t.scales[e.x],n=t.scales[e.y];let i,o=null,s=!0;if(Array.isArray(a.dim)?(s=!1,((i=a.dim)[0]===r.dim&&i[1]===n.dim||i[0]===n.dim&&i[1]===r.dim)&&(o=["x","y"])):a.dim===r.dim?o=["x","y"]:a.dim===n.dim&&(o=["y","x"]),null===o)return void(e=>t.settings.log(e,"LOG"))("Annotation doesn't match any field");var l=a.text,u={type:"ELEMENT.LINE",namespace:"annotations",x:e.x,y:e.y,label:"annotation_text",color:a.colorScaleName,expression:{inherit:!1,operator:"none",params:[],source:"/"},guide:{animationSpeed:e.guide.animationSpeed,showAnchors:"never",widthCssClass:"tau-chart__line-width-2",cssClass:"tau-chart__annotation-line",label:{fontColor:a.color,position:s?["r","b","keep-in-box"]:["auto:avoid-label-edges-overlap","auto:adjust-on-label-overflow","keep-in-box"]},x:{fillGaps:!1},y:{fillGaps:!1}}};let f=s?{transformModel:[d(a)],transformation:[{type:"dataLimit",args:{from:a.val,startText:"string"==typeof l?"":l.start,endText:"string"==typeof l?l:l.end,primaryScale:e[o[0]],secondaryScale:e[o[1]]}}]}:{transformation:[{type:"lineNoteData",args:{points:i[0]===r.dim?a.val:a.val.map(t=>t.slice().reverse()),startText:"string"==typeof l?"":l.start,endText:"string"==typeof l?l:l.end,xScale:e.x,yScale:e.y}}]};Object.assign(u,f),c(e.units,u,a.position)},onRender(){this._clearUnusedDataRefs()},onSpecReady(t,a){var r=this,n=[];this._setupAdditionalSeries(),this._startWatchingDataRefs(),t.traverseSpec(a,function(t){t&&"COORDS.RECT"===t.type&&t.units&&n.push(t)}),this._formatters=l.getFieldFormatters(a,e.formatters);var o=l.spec(a);n.forEach(function(t){e.items.map(function(t,e){var a=(t.color||"#BD10E0").toLowerCase(),r=i.rgb(a).toString();"black"!==a&&"rgb(0, 0, 0)"===r&&(r=null);var n=r||a,s="annotation_color_"+e;return o.addScale(s,{type:"color",source:"?",brewer:[n]}),{dim:t.dim,val:t.val,text:t.text,color:n,position:t.position,colorScaleName:s}}).forEach(function(e){Array.isArray(e.dim)?Array.isArray(e.val)&&e.val.every(Array.isArray)?r.addLineNote(a,t,e):(t=>a.settings.log(t,"LOG"))("Point annotation is not implemented yet"):Array.isArray(e.val)?r.addAreaNote(a,t,e):r.addLineNote(a,t,e)})})},_setupAdditionalSeries:function(){const t=this._chart,a=t.getSpec(),r=t.getDataSources()["/"].data,n=this._getAnnotatedDimValues(e.items);Object.keys(n).forEach(t=>{[`x_${t}`,`y_${t}`].forEach(e=>{if(e in a.scales){const i=a.scales[e],o=r.map(e=>e[t]),l=["period","time"].indexOf(i.type)>=0?n[t].map(t=>new Date(t)):n[t];i.series=s.unique(o.concat(l))}})})},_getFormat(t){return this._formatters[t]?this._formatters[t].format:t=>String(t)},_useSavedDataRefs(t,e){const a=this._dataRefs;return this._usedDataRefsKeys.add(e),e in a?(a[e].forEach((e,a)=>Object.assign(e,t[a])),a[e]):(a[e]=t,t)},_startWatchingDataRefs(){const t=this._dataRefs;this._initialDataRefsKeys=new Set(Object.keys(t)),this._usedDataRefsKeys=new Set},_clearUnusedDataRefs(){const t=this._dataRefs,e=this._initialDataRefsKeys,a=this._usedDataRefsKeys;Array.from(e).filter(t=>!a.has(t)).forEach(e=>delete t[e]),this._initialDataRefsKeys=null,this._usedDataRefsKeys=null},_getDataRowsFromItems(t){const e=(t,e)=>t.reduce((t,a,r)=>(t[a]=e[r],t),{});return t.reduce((t,a)=>(Array.isArray(a.dim)?Array.isArray(a.val)&&a.val.every(Array.isArray)&&a.val.forEach(r=>{t.push(e(a.dim,r))}):Array.isArray(a.val)?a.val.forEach(r=>{t.push(e([a.dim],[r]))}):t.push(e([a.dim],[a.val])),t),[])},_getAnnotatedDimValues(t){const e=this._getDataRowsFromItems(t),a={};return e.forEach(t=>{Object.keys(t).forEach(e=>{a[e]=a[e]||[],a[e].push(t[e])})}),a}}}n.a.api.plugins.add("annotations",u),e.default=u},5:function(t,a){t.exports=e}})});