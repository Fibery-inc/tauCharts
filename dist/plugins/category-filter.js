/*!
 * /*
 * taucharts@2.7.0 (2019-03-08)
 * Copyright 2019 Targetprocess, Inc.
 * Licensed under Apache License 2.0
 * * /
 * 
 */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("taucharts"));else if("function"==typeof define&&define.amd)define(["taucharts"],t);else{var r="object"==typeof exports?t(require("taucharts")):t(e.Taucharts);for(var i in r)("object"==typeof exports?exports:e)[i]=r[i]}}(window,function(e){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=17)}({0:function(t,r){t.exports=e},17:function(e,t,r){"use strict";r.r(t),r.d(t,"default",function(){return b});var i=r(0),n=r.n(i);const s=n.a.api.utils,o=n.a.api.pluginsSDK,l="tau-chart__category-filter",a=`${l}__value`,c=`${a}_checked`,d=`${a}__toggle`,u=e=>e.join("\n"),h=({categories:e})=>`\n    <div class="${l}">\n        ${u(e.map(e=>f(e)))}\n    </div>\n`,f=({label:e,values:t})=>`\n    <div class="${l}__category">\n        <div class="${l}__category__label">${e}</div>\n        <div class="${l}__category__values">\n            ${u(t.map(e=>_(e)))}\n    </div>\n\n`,_=({key:e,label:t,checked:r})=>`\n    <div class="${a}${r?` ${c}`:""}" data-key="${e}">\n        ${g()}\n        <span class="${a}__label">${t}</span>\n    </div>\n`,g=()=>[`<span class="${d}">`,`<span class="${d}__icon"></span>`,"</span>"].join(""),m=e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild},p=(e,t,r,i)=>{e.addEventListener(t,function(e){let t=e.target;for(;t!==e.currentTarget&&null!==t;)t.matches(r)&&i(e,t),t=t.parentNode})},y=(e,t)=>{const r=e=>JSON.stringify((e=>null==e||""===e)(e)?null:e),i=r(t);return t=>{const n=t[e],s=r(n);return i===s}};class v{constructor(e){this.settings=s.defaults(e||{},{formatters:{},fields:null,skipColorDim:!0}),this._filters={},this.onRender=this._createRenderHandler()}init(e){this._chart=e;const t=t=>{const r=e.getSpec().scales;return Object.keys(r).map(e=>{return{name:e,config:r[e]}}).filter(t)};let r=t(({config:e,name:t})=>"ordinal"===e.type&&e.dim),i=s.unique(r.map(({config:e})=>e.dim));if(this.settings.fields&&(i=i.filter(e=>this.settings.fields.indexOf(e)>=0)),this.settings.skipColorDim){const e=t(({config:e,name:t})=>"color"===e.type&&e.dim).map(({config:e})=>e.dim);i=i.filter(t=>e.indexOf(t)<0)}r=r.filter(e=>i.indexOf(e.config.dim)>=0),this._categoryScales=r,this._render()}destroy(){const e=this._filters,t=this._chart;Object.keys(e).forEach(r=>t.removeFilter(e[r]));(e=>e&&e.parentElement&&e.parentElement.removeChild(e))(this._node)}_createRenderHandler(){return function(){if(this._lastClickedScrollInfo){const e=this._lastClickedScrollInfo.key,t=this._node.querySelector(`[data-key="${e}"]`);if(t){const e=this._lastClickedScrollInfo.top,r=t.getBoundingClientRect().top,i=this._getScrollContainer(),n=i.getBoundingClientRect().top;i.scrollTop=i.scrollTop-e-n+r}this._lastClickedScrollInfo=null}}}_getContent(e){return h({categories:e})}_getCategoriesInfo(){return this._categoryScales.map(({name:e})=>this._chart.getScaleInfo(e)).map(e=>{const t=e.dim,r=this._getFieldLabel(t),i=this._getFieldFormat(t),n=this._chart.getDataSources({excludeFilter:["category-filter"]}),o=s.unique(n[e.source].data.map(e=>e[t])).map(e=>{const r=i(e),n=this._getFilterKey(t,e);return{label:r,checked:!this._filters[n],key:n,value:e}});return{dim:t,label:r,values:o}})}_render(){this._clear(),this._formatters=o.getFieldFormatters(this._chart.getSpec(),this.settings.formatters);const e=this._getCategoriesInfo(),t=this._getContent(e),r=m(t);this._node=r,this._chart.insertToRightSidebar(r),this._subscribeToEvents(),this._filterKeys=e.reduce((e,t)=>{const r=t.dim;return t.values.forEach(({key:t,value:i})=>{e[t]={dim:r,value:i}}),e},{})}_subscribeToEvents(){const e=this._node;p(e,"click",`.${a}`,(e,t)=>{const r=t.getAttribute("data-key"),i=e.target.matches(`.${d}`);this._toggleCategory(r,i?"toggle":"focus")}),p(e,"mouseover",`.${a}`,(e,t)=>{const r=t.getAttribute("data-key");this._toggleHighlight(r,!0)}),p(e,"mouseout",`.${a}`,(e,t)=>{const r=t.getAttribute("data-key");this._toggleHighlight(r,!1)})}_isFilteredOut(e){return e in this._filters}_toggleCategory(e,t){const r=Array.from(this._node.querySelectorAll(`.${a}`)).reduce((e,t)=>{return e[t.getAttribute("data-key")]=t,e},{}),i=Object.keys(this._filterKeys).map(e=>{const{dim:t,value:i}=this._filterKeys[e];return{node:r[e],key:e,dim:t,value:i,isChecked:!this._isFilteredOut(e)}}),n=i.reduce((e,t)=>(e[t.key]=t,e),{})[e],s=i.filter(e=>e.dim===n.dim),o=(e,t)=>{t?e.classList.add(c):e.classList.remove(c)};switch(t){case"toggle":n.isChecked?(this._addFilter(e),o(n.node,!1)):(this._removeFilter(e),o(n.node,!0));break;case"focus":n.isChecked&&s.every(e=>e===n||!e.isChecked)?s.forEach(e=>{e.isChecked||(o(e.node,!0),this._removeFilter(e.key))}):(s.forEach(e=>{e!==n&&e.isChecked&&(o(e.node,!1),this._addFilter(e.key))}),n.isChecked||(o(n.node,!0),this._removeFilter(n.key)));break}this._lastClickedScrollInfo={key:e,top:n.node.getBoundingClientRect().top-this._getScrollContainer().getBoundingClientRect().top},this._chart.refresh()}_toggleHighlight(e,t){if(this._isFilteredOut(e))return;const{dim:r,value:i}=this._filterKeys[e],n=t?y(r,i):e=>null;this._chart.select(e=>!0).forEach(e=>e.fire("highlight",n))}_clear(){const e=this._node;e&&e.parentElement&&e.parentElement.removeChild(e)}_getScrollContainer(){return this._node.parentElement.parentElement}_getFilterKey(e,t){return`${e}__${t}`}_addFilter(e){const{dim:t,value:r}=this._filterKeys[e],i=y(t,r);this._filters[e]=this._chart.addFilter({tag:"category-filter",predicate:e=>!i(e)})}_removeFilter(e){const t=this._filters[e];delete this._filters[e],this._chart.removeFilter(t)}_getFieldLabel(e){return this._formatters[e]?this._formatters[e].label:e}_getFieldFormat(e){return this._formatters[e]?this._formatters[e].format:e=>String(e)}}function b(e){return new v(e)}n.a.api.plugins.add("category-filter",b)}})});